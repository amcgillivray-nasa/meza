echo "******* Generating elasticsearch index *******"

# Remove any broken cirrus update jobs
mysql "wiki_$wiki_id" -e "DELETE FROM job WHERE job_cmd = 'cirrusSearchElasticaWrite'"

# Run script to generate elasticsearch index
cd "{{ m_mediawiki }}"
WIKI="$wiki_id" php "{{ m_mediawiki }}/extensions/CirrusSearch/maintenance/UpdateSearchIndexConfig.php" --startOver

# Remove search-update disable in wiki-specific settings
rm -f "$disable_search_file"

# Restart PHP/Apache to ensure ^ change is picked up
systemctl restart httpd
systemctl restart php-fpm

# Bootstrap the search index
#
# Note that this can take some time
# For large wikis read "Bootstrapping large wikis" in https://git.wikimedia.org/blob/mediawiki%2Fextensions%2FCirrusSearch.git/REL1_25/README
WIKI="$wiki_id" php "{{ m_mediawiki }}/extensions/CirrusSearch/maintenance/ForceSearchIndex.php" --skipLinks --indexOnSkip
WIKI="$wiki_id" php "{{ m_mediawiki }}/extensions/CirrusSearch/maintenance/ForceSearchIndex.php" --skipParse

echo "******* Elastic Search build index complete! *******"
